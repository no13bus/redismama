<!doctype html>
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="http://cdn.bootcss.com/pubnub/3.7.7/pubnub.min.js"></script>
<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/pubnub-angular/lib/pubnub-angular.js"></script>
<script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.bootcss.com/highcharts/4.0.4/highcharts.js"></script>
  <script type="text/javascript" src="http://cdn.hcharts.cn/highcharts/exporting.js"></script>
  <script src="bower_components/highchart-ng/dist/highcharts-ng.js"></script>
<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css">
<script src="http://cdn.bootcss.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script>src="http://cdn.bootcss.com/bootstrap/2.3.1/js/bootstrap-tooltip.min.js"</script>


</head>

<body>
<div class="container" ng-app="PubNubAngularApp" ng-controller="ChatCtrl">
<!--         <button class="btn btn-primary" ng-click="addPoints()">Add Points</button>
        <input type="text" ng-model="a" ng-change="changetitle(t)">aaa -->
        <input type="text" >bbb
        <p>the title is {{ chartConfig.title.text }}</p>
        <div class="row">
            <highchart id="command" config="chartConfig" class="col-md-4"></highchart>
            <highchart id="cpu" config="chartConfig" class="col-md-4"></highchart>
            <highchart id="memory" config="chartConfig" class="col-md-4"></highchart>
        </div>
        <br />
        <a href="#" class="tooltip-test" data-toggle="tooltip" 
   title="默认的 Tooltip">
   默认的 Tooltip
</a>.
        <div class="row">
          <table id="table" class="table table-bordered col-md-10 table-striped">
            <th>time</th>
            <th>us</th>
            <th>sy</th>
            <th>cl</th>
            <th>bcl</th>
            <th>mem</th>
            <th>rss</th>
            <th>keys</th>
            <th>cmd/s</th>
            <th>exp/s</th>
            <th>evt/s</th>
            <th>hit/s</th>
            <th>mis/s</th>
            <th>aofcs</th>
            <tr ng-repeat="row in table">
                <td ng-repeat="td in row">
                    {{ td }}
                </td>
            </tr>
          </table>
        </div>
        <br /><br /><br />
        <div class="row">
            <div class="col-md-4">
                <table id="stat" class="table table-bordered table-striped">
                    <tr ng-repeat="item in stat">
                       <td>{{ item.key }}</td>   
                       <td>{{ item.value }}</td>
                    </tr>
                </table>
            </div>
          
        </div>

</div>

<script>
//
// Set Up Your Angular Module & Controller(s)
//
angular.module('PubNubAngularApp', ["pubnub.angular.service", "highcharts-ng"])
.controller('ChatCtrl', function($rootScope, $scope, $location, $filter, PubNub) {

   ///highchart setting
   $scope.stat = [];
   $scope.table = [];
   $scope.chartConfig = {
        options: {
           global: { 
                useUTC: false
            },
            chart: {
              useUTC: false,
                type: 'spline',
            }
        },
        series: [{
            data: []
        }
        ],
        title: {
            text: 'Hello'
        },
        xAxis: {
                    type: 'datetime',
                    title: {
                        text: '时间轴'
                    }
                },
        yAxis: {
            title: {
                text: 'value'
            },
            
        },
    }
    $scope.changetitle = function () {
      var title = $scope.chartConfig.title;
      title.text = $scope.a;

    }
    $scope.addPoints = function () {
        var seriesArray = $scope.chartConfig.series
        
        seriesArray[0].data.push(1);
        seriesArray[0].data.shift();
    };
   

  // make up a user id (you probably already have this)
  $scope.userId   = "User " + Math.round(Math.random() * 1000);
  // make up a channel name
  $scope.channel  = 'redismama';
  // pre-populate any existing messages (just an AngularJS scope object)
  $scope.messages = ['Welcome to ' + $scope.channel];
  // $scope.messages = ["a","b","a", "b"];
  if (!$rootScope.initialized) {
    // Initialize the PubNub service
    PubNub.init({
      subscribe_key: 'sub-c-9a43842c-a77a-11e4-85d5-0619f8945a4f',
      publish_key: 'pub-c-574982bb-d7cc-4ec1-9683-fe1d89b144ad',
      uuid:$scope.userId
    });
    $rootScope.initialized = true;
  }
  // Subscribe to the Channel
  PubNub.ngSubscribe({ channel: $scope.channel });
  // Create a publish() function in the scope
  $scope.publish = function() {
    PubNub.ngPublish({
      channel: $scope.channel,
      message: "[" + $scope.userId + "] " + $scope.newMessage
    });
    $scope.newMessage = '';
  };
  var seriesArray = $scope.chartConfig.series;
  function handle_status(msg) {
        $scope.stat = [];
        $scope.stat.push({"key":"redis_version","value":msg.redis_version})
        $scope.stat.push({"key":"redis_mode","value":msg.redis_mode})
        $scope.stat.push({"key":"process_id","value":msg.process_id})
        $scope.stat.push({"key":"uptime_in_seconds","value":msg.uptime_in_seconds})
        $scope.stat.push({"key":"uptime_in_days","value":msg.uptime_in_days})
        $scope.stat.push({"key":"role","value":msg.role})
        $scope.stat.push({"key":"connected_slaves","value":msg.connected_slaves})
        $scope.stat.push({"key":"aof_enabled","value":msg.aof_enabled})
        $scope.stat.push({"key":"rdb_bgsave_in_progress","value":msg.rdb_bgsave_in_progress})
        $scope.stat.push({"key":"rdb_last_save_time","value":$filter('date')(msg.rdb_last_save_time, "hh:mm:ss")})

  }
  var last_total_commands_processed = 0;
  var last_expired_keys = 0;
  var last_evicted_keys = 0;
  var last_keyspace_hits = 0;
  var last_keyspace_misses = 0;
  function handle_table(msg) {
      
      // var time2 = $filter('date')(new Date(), "hh:mm:ss");
      var us = msg.used_cpu_user;
      var sy = msg.used_cpu_sys;
      var cl = msg.connected_clients;
      var bcl = msg.blocked_clients;
      var mem = msg.used_memory_human;
      var rss = (msg.used_memory_rss/1024/1024).toFixed(2) + "M";
      // console.log(rss);
      // var rss = $filter('number')(msg.used_memory_rss/1024/1024, 2); 不知道为什么这样的不行。
      // var keys = msg.
      var keys = 0;
      for (var i = 0; i < 16; i++) {
           // console.log(msg.hasOwnProperty("db" + i));
          if (msg.hasOwnProperty("db" + i) == true){
               keys = keys + msg["db" + i]["keys"];
          }
          
      };
      var cmd_per_second = 0;
      var expired_keys_per_second = 0;
      var evicted_keys_per_second = 0;
      var keyspace_hits_per_second = 0;
      var keyspace_misses_per_second = 0;
      var aof_current_size = 0;
      if ($scope.table.length > 0) {
          cmd_per_second = (msg.total_commands_processed - last_total_commands_processed)/1;
          expired_keys_per_second = (msg.expired_keys - last_expired_keys)/1;
          evicted_keys_per_second = (msg.evicted_keys - last_evicted_keys)/1;
          keyspace_hits_per_second = (msg.keyspace_hits - last_keyspace_hits)/1;
          keyspace_misses_second = (msg.keyspace_misses - last_keyspace_misses)/1;
      }
      last_total_commands_processed = msg.total_commands_processed;
      last_expired_keys = msg.expired_keys;
      last_evicted_keys = msg.evicted_keys;
      last_keyspace_hits = msg.keyspace_hits;
      last_keyspace_misses = msg.keyspace_misses
      // console.log(msg.total_commands_processed);
      if (msg.aof_enabled) {
        aof_current_size = (msg.aof_current_size/1024/1024).toFixed(2) + "M";
      }

      $scope.table.unshift([msg.time,us,sy,cl,bcl,mem,rss,keys,cmd_per_second,expired_keys_per_second,evicted_keys_per_second,keyspace_hits_per_second,keyspace_misses_per_second,aof_current_size]);
      if ($scope.table.length > 10) {
            $scope.table.pop();
      }
      
  }

  // Register for message events
  $rootScope.$on(PubNub.ngMsgEv($scope.channel), function(ngEvent, payload) {
    $scope.$apply(function() {
      handle_status(payload.message);
      handle_table(payload.message);
    });
  });
  



});
</script>
</body>
</html>



