<!doctype html>
<html>

<head>
    <script src="http://cdn.bootcss.com/pubnub/3.7.7/pubnub.min.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/pubnub-angular/lib/pubnub-angular.js"></script>
    <script type="text/javascript" src="http://cdn.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="http://cdn.hcharts.cn/highcharts/highcharts.js"></script>
    <script type="text/javascript" src="http://cdn.hcharts.cn/highcharts/exporting.js"></script>
    <script src="js/highchart.js"></script>

</head>

<body>
    <div ng-app="PubNubAngularApp">




        <h4>Online Users</h4>
        <ul>
            <li ng-repeat="user in users">{{user}}</li>
        </ul>

        <br />

        <h4>Chat History ({{messages.length}})</h4>

        <form ng-submit='publish()'>
            <input type="text" ng-model='newMessage' />
            <input type="submit" value="Send" />
        </form>

        <br />

        <div class="well">
            <ul>
                <li ng-repeat="message in messages">{{message}}</li>
            </ul>
        </div>
        <div id="container" style="min-width:700px;height:400px"></div>
    </div>
    <!-- </div> -->
    <script>
    //
    // Set Up Your Angular Module & Controller(s)
    //
    angular.module('PubNubAngularApp', ["pubnub.angular.service"], ['highcharts-ng'])
        .controller('myctrl', function($rootScope, $scope, $location, PubNub) {
            // make up a user id (you probably already have this)
            $scope.userId = "User " + Math.round(Math.random() * 1000);
            // make up a channel name
            $scope.channel = 'The Angular Channel';
            // pre-populate any existing messages (just an AngularJS scope object)
            $scope.messages = ['Welcome to ' + $scope.channel];
            if (!$rootScope.initialized) {
                // Initialize the PubNub service
                PubNub.init({
                    subscribe_key: 'demo',
                    publish_key: 'demo',
                    uuid: $scope.userId
                });
                $rootScope.initialized = true;
            }
            // Subscribe to the Channel
            PubNub.ngSubscribe({
                channel: $scope.channel
            });
            // Create a publish() function in the scope
            $scope.publish = function() {
                PubNub.ngPublish({
                    channel: $scope.channel,
                    message: "[" + $scope.userId + "] " + $scope.newMessage
                });
                $scope.newMessage = '';
            };
            // Register for message events
            $rootScope.$on(PubNub.ngMsgEv($scope.channel), function(ngEvent, payload) {
                $scope.$apply(function() {
                    $scope.messages.push(payload.message); ////////////main show data code
                });
            });
            // Register for presence events (optional)
            // $rootScope.$on(PubNub.ngPrsEv($scope.channel), function(ngEvent, payload) {
            //   $scope.$apply(function() {
            //     $scope.users = PubNub.ngListPresence($scope.channel);
            //   });
            // });
            // Pre-Populate the user list (optional)
            // PubNub.ngHereNow({
            //   channel: $scope.channel
            // });

            // Populate message history (optional)
            // PubNub.ngHistory({
            //   channel: $scope.channel,
            //   count: 2
            // });
            Highcharts.setOptions({
                global: {
                    useUTC: false
                }
            });

            var chart;
            $('#container').highcharts({
                chart: {
                    type: 'spline',
                    animation: Highcharts.svg, // don't animate in old IE               
                    marginRight: 10,
                    events: {
                        load: function() {

                            // set up the updating of the chart each second             
                            var series = this.series[0];
                            var series1 = this.series[1];
                            setInterval(function() {
                                var x = (new Date()).getTime(), // current time         
                                    y = Math.random();
                                // var x1 = (new Date()).getTime(), // current time         
                                //     y1 = Math.random();                                
                                series.addPoint([x, y], true, true);
                                // series1.addPoint([x1, y1], true, true);                 
                            }, 2000);
                        }
                    }
                },
                title: {
                    text: 'Live random data'
                },
                xAxis: {
                    type: 'datetime',
                    tickPixelInterval: 150
                },
                yAxis: {
                    title: {
                        text: 'Value'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                tooltip: {
                    formatter: function() {
                        return '<b>' + this.series.name + '</b><br/>' +
                            Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                            Highcharts.numberFormat(this.y, 2);
                    }
                },
                legend: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                series: [{
                        name: 'Random data',
                        data: (function() {
                            // generate an array of random data                             
                            var data = [],
                                time = (new Date()).getTime(),
                                i;

                            for (i = -5; i <= 0; i++) {
                                data.push({
                                    x: time + i * 1000,
                                    y: Math.random()
                                });
                            }
                            return data;
                        })()
                    },


                ]
            });




        });
    </script>
    <script>
    var myapp = angular.module('myapp', ["highcharts-ng", "pubnub.angular.service"]);

    myapp.controller('myctrl', function($scope, PubNub) {

        $scope.addPoints = function() {
            var seriesArray = $scope.chartConfig.series
            var rndIdx = Math.floor(Math.random() * seriesArray.length);
            seriesArray[0].data.push(1);
            seriesArray[0].data.shift();
        };
        $scope.chartConfig = {
            options: {
                chart: {
                    type: 'line',
                    zoomType: 'x'
                }
            },
            series: [{
                data: [10, 15, 12, 8, 7, 1, 1, 19, 15, 10]
            }],
            title: {
                text: 'Hello'
            },

            loading: false
        }

    });
    </script>
</body>

</html>